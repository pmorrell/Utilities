#!/bin/bash

#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=16
#SBATCH --mem=740gb
#SBATCH -t 24:00:00
#SBATCH --mail-type=ALL
#SBATCH --mail-user=pmorrell@umn.edu
#SBATCH -p msismall,amdsmall
#SBATCH -o %j.out
#SBATCH -e %j.err

#-------------------------------------------------------------------------------
# GLnexus Joint Genotyping Script for DeepVariant gVCFs
# 
# This script takes a list of gVCFs generated by DeepVariant and uses GLnexus 
# to perform joint calling, which will properly backfill homozygous reference 
# ("0/0") calls for samples that match the reference.
#-------------------------------------------------------------------------------

# --- Modules / Environment ---
module load htslib/1.16-gcc-8.2.0-x236tnl
module load bcftools/1.21
module load miniforge

# Initialize conda for this script, then activate
eval "$(conda shell.bash hook)"
conda activate glnexus

# --- Project Paths & Variables ---
# File containing the list of your 59 gVCFs (full paths, one per line)
GVCF_LIST="/scratch.global/pmorrell/Cowpea/cowpea_59_UG100.txt"

# Output variables (Fixed missing 'pmorrell' in path)
OUT_DIR="/scratch.global/pmorrell/Cowpea/Joint_Genotyping"
OUT_PREFIX="Cowpea_UG100_Cohort"

# Scratch directory for the GLnexus RocksDB
# VERY IMPORTANT: GLnexus will fail if this directory already exists!
SCRATCH_DB="/scratch.global/${USER}/glnexus_db_${SLURM_JOB_ID}"

# GLnexus Configuration Profile
# DeepVariantWGS is for whole genome. DeepVariantWES is for exome/capture.
GLNEXUS_CONFIG="DeepVariantWGS"

# --- Setup ---
mkdir -p "${OUT_DIR}"

# Ensure the database directory doesn't exist yet
if [ -d "${SCRATCH_DB}" ]; then
    echo "Warning: Scratch DB directory exists. Removing it..."
    rm -rf "${SCRATCH_DB}"
fi

# Convert the gVCF list file into a space-separated string for GLnexus
GVCF_FILES=$(cat "${GVCF_LIST}" | tr '\n' ' ')

# --- Execution ---
echo "Starting GLnexus joint calling using configuration: ${GLNEXUS_CONFIG}..."

# 1. Run GLnexus
# It outputs a binary BCF file directly to stdout, which we redirect.
glnexus_cli \
    --config ${GLNEXUS_CONFIG} \
    --threads ${SLURM_CPUS_PER_TASK} \
    --mem-gbytes 720 \
    --dir "${SCRATCH_DB}" \
    ${GVCF_FILES} \
    > "${OUT_DIR}/${OUT_PREFIX}.bcf"

echo "GLnexus complete. Converting BCF to gzipped VCF..."

# 2. Convert BCF to bgzipped VCF
bcftools view \
    --threads ${SLURM_CPUS_PER_TASK} \
    "${OUT_DIR}/${OUT_PREFIX}.bcf" \
    | bgzip -c -@ ${SLURM_CPUS_PER_TASK} > "${OUT_DIR}/${OUT_PREFIX}.vcf.gz"

echo "Conversion complete. Indexing final VCF..."

# 3. Index the final VCF
tabix -p vcf "${OUT_DIR}/${OUT_PREFIX}.vcf.gz"

# 4. Cleanup
echo "Cleaning up temporary GLnexus database..."
rm -rf "${SCRATCH_DB}"

echo "Joint genotyping pipeline finished successfully."

